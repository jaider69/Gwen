<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gwen - Asistente Virtual</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/recorder.css') }}">
</head>
<body>
    <div class="container">
        <h1>üéØ Gwen - Asistente Virtual</h1>
        <p class="subtitle">Gesti√≥n de inventario por voz para tu tienda de barrio</p>

        <!-- Pesta√±as de navegaci√≥n -->
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('home-tab')">üè† Inicio</button>
            <button class="tab-button" onclick="openTab('inventory-tab')">üì¶ Inventario Completo</button>
            <button class="tab-button" onclick="openTab('alerts-tab')">üö® Alertas</button>
            <button class="tab-button" onclick="openTab('activities-tab')">üìã Actividades</button>
        </div>

        <div class="voice-section">
            <div class="voice-indicator" id="voiceIndicator">üé§</div>
            <button class="control-btn" id="controlBtn" onclick="toggleVoiceSystem()">
                üöÄ Iniciar Sistema de Voz
            </button>
            <div class="status-text" id="statusText">
                Presiona el bot√≥n para comenzar
            </div>
            
            <div class="info-box">
                <strong>üìñ C√≥mo usar:</strong>
                <ul>
                    <li>Di "Gwen" o "Gen" para activar (pronuncia claramente)</li>
                    <li>Ejemplo: "Gwen, agrega 10 galletas"</li>
                    <li>Ejemplo: "Gen, vend√≠ 5 leches"</li>
                    <li>Ejemplo: "Gwen, actualiza arroz a 20"</li>
                    <li>üí° Tambi√©n funciona: "Bueno", "Guen", "Wen"</li>
                </ul>
            </div>
        </div>

        <!-- Pesta√±a INICIO -->
        <div id="home-tab" class="tab-content active">
            <div class="home-dashboard">
                <!-- Historial de Movimientos Recientes -->
                <div class="home-section">
                    <h2>üìã Historial de Movimientos Recientes</h2>
                    <p class="sub-info">√öltimas acciones realizadas por voz</p>
                    <div id="homeActivitiesList" class="home-activities"></div>
                </div>

                <!-- Productos Interactivos -->
                <div class="home-section">
                    <h2>üéØ Productos Activos</h2>
                    <p class="sub-info">Productos que has modificado recientemente</p>
                    <div class="inventory-grid" id="interactiveInventoryGrid"></div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a INVENTARIO COMPLETO - MEJORADA -->
        <div id="inventory-tab" class="tab-content">
            <div class="inventory-complete-container">
                <!-- Inventario de Productos -->
                <div class="inventory-products-section">
                    <h2>üì¶ Todos los Productos</h2>
                    <div class="inventory-stats">
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-info">
                                <div class="stat-value" id="totalProducts">0</div>
                                <div class="stat-label">Total Productos</div>
                            </div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-icon">‚ö†Ô∏è</div>
                            <div class="stat-info">
                                <div class="stat-value" id="lowStockProducts">0</div>
                                <div class="stat-label">Stock Bajo</div>
                            </div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-icon">‚úÖ</div>
                            <div class="stat-info">
                                <div class="stat-value" id="goodStockProducts">0</div>
                                <div class="stat-label">Stock Bueno</div>
                            </div>
                        </div>
                    </div>
                    <div class="inventory-grid" id="inventoryGrid"></div>
                </div>

                <!-- Historial Completo con Filtros -->
                <div class="history-section">
                    <div class="history-header">
                        <h2>üìú Historial Completo</h2>
                        <button class="btn-clear-filters" onclick="clearFilters()">üîÑ Limpiar Filtros</button>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="filters-container">
                        <div class="filter-group">
                            <label for="filterType">üìã Tipo de Acci√≥n</label>
                            <select id="filterType" onchange="applyFilters()">
                                <option value="all">Todas las acciones</option>
                                <option value="add">‚ûï Agregar</option>
                                <option value="sell">üí∞ Venta</option>
                                <option value="update">üîÑ Actualizaci√≥n</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="filterProduct">üè∑Ô∏è Producto</label>
                            <select id="filterProduct" onchange="applyFilters()">
                                <option value="all">Todos los productos</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="filterDate">üìÖ Fecha</label>
                            <select id="filterDate" onchange="applyFilters()">
                                <option value="all">Todo el tiempo</option>
                                <option value="today">Hoy</option>
                                <option value="week">√öltima semana</option>
                                <option value="month">√öltimo mes</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="searchHistory">üîç Buscar</label>
                            <input type="text" id="searchHistory" placeholder="Buscar en historial..." oninput="applyFilters()">
                        </div>
                    </div>

                    <!-- Estad√≠sticas del Historial -->
                    <div class="history-stats">
                        <div class="history-stat-item">
                            <span class="history-stat-label">Total movimientos:</span>
                            <span class="history-stat-value" id="totalMovements">0</span>
                        </div>
                        <div class="history-stat-item">
                            <span class="history-stat-label">Mostrando:</span>
                            <span class="history-stat-value" id="filteredMovements">0</span>
                        </div>
                    </div>

                    <!-- Lista de Historial -->
                    <div id="fullHistoryList" class="full-history-list"></div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Alertas -->
        <div id="alerts-tab" class="tab-content">
            <div class="alerts-container">
                <div class="alert-section">
                    <h2>‚ö†Ô∏è Productos con Stock Bajo</h2>
                    <div class="alert-grid" id="lowStockAlerts"></div>
                </div>
                
                <div class="alert-section">
                    <h2>üìÖ Productos Pr√≥ximos a Vencer</h2>
                    <div class="alert-grid" id="expiryAlerts"></div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Actividades (completa) -->
        <div id="activities-tab" class="tab-content">
            <div class="full-activities-section">
                <h2>üìã Historial Completo de Actividades</h2>
                <div id="fullActivitiesList"></div>
            </div>
        </div>
    </div>

    <script>
        let isSystemActive = false;
        let pollInterval = null;
        let allActivities = [];
        let filteredActivities = [];

        // Sistema de pesta√±as
        function openTab(tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let tab of tabContents) {
                tab.classList.remove('active');
            }

            const tabButtons = document.getElementsByClassName('tab-button');
            for (let button of tabButtons) {
                button.classList.remove('active');
            }

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            if (tabName === 'home-tab') {
                loadHomeDashboard();
            } else if (tabName === 'inventory-tab') {
                loadInventoryComplete();
            } else if (tabName === 'alerts-tab') {
                loadAlerts();
            } else if (tabName === 'activities-tab') {
                loadFullActivities();
            }
        }

        async function toggleVoiceSystem() {
            const btn = document.getElementById('controlBtn');
            const indicator = document.getElementById('voiceIndicator');
            const statusText = document.getElementById('statusText');

            if (!isSystemActive) {
                try {
                    statusText.textContent = '‚è≥ Iniciando sistema...';
                    const response = await fetch('/api/start-voice-system', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        isSystemActive = true;
                        btn.textContent = 'üõë Detener Sistema';
                        btn.classList.add('stop');
                        indicator.classList.add('listening');
                        statusText.textContent = 'üëÇ Escuchando "Gwen"...';

                        pollInterval = setInterval(() => {
                            const activeTab = document.querySelector('.tab-content.active').id;
                            if (activeTab === 'home-tab') {
                                loadHomeDashboard();
                            } else if (activeTab === 'inventory-tab') {
                                loadInventoryComplete();
                            } else if (activeTab === 'alerts-tab') {
                                loadAlerts();
                            }
                        }, 2000);

                        loadHomeDashboard();
                    } else {
                        statusText.textContent = '‚ùå Error al iniciar';
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('‚ùå Error iniciando sistema:', error);
                    statusText.textContent = '‚ùå Error de conexi√≥n';
                    alert('Error al iniciar el sistema de voz. Verifica la consola.');
                }
            } else {
                try {
                    const response = await fetch('/api/stop-voice-system', { method: 'POST' });

                    isSystemActive = false;
                    btn.textContent = 'üöÄ Iniciar Sistema de Voz';
                    btn.classList.remove('stop');
                    indicator.classList.remove('listening', 'active', 'recording');
                    statusText.textContent = 'üîá Sistema detenido';

                    if (pollInterval) clearInterval(pollInterval);
                } catch (error) {
                    console.error('Error deteniendo sistema:', error);
                }
            }
        }

        // NUEVA FUNCI√ìN: Cargar inventario completo con historial
        async function loadInventoryComplete() {
            await loadInventoryWithStats();
            await loadFullHistory();
        }

        // Cargar inventario con estad√≠sticas
        async function loadInventoryWithStats() {
            try {
                const response = await fetch('/api/inventory');
                const inventory = await response.json();

                // Calcular estad√≠sticas
                const totalProducts = inventory.length;
                const lowStockProducts = inventory.filter(p => p.stock <= p.minStock).length;
                const goodStockProducts = totalProducts - lowStockProducts;

                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('lowStockProducts').textContent = lowStockProducts;
                document.getElementById('goodStockProducts').textContent = goodStockProducts;

                // Mostrar productos
                const grid = document.getElementById('inventoryGrid');
                grid.innerHTML = '';

                inventory.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    if (product.stock <= product.minStock) {
                        card.classList.add('low-stock');
                    }

                    const stockPercentage = (product.stock / (product.minStock * 2)) * 100;

                    card.innerHTML = `
                        <div class="product-name">${product.name}</div>
                        <div class="product-category">üìÅ ${product.category}</div>
                        <div class="product-stock">üì¶ Stock: ${product.stock} unidades</div>
                        <div class="product-stock-bar">
                            <div class="stock-bar-fill ${product.stock <= product.minStock ? 'low' : 'good'}" 
                                 style="width: ${Math.min(stockPercentage, 100)}%"></div>
                        </div>
                        <div class="product-stock" style="font-size: 12px; color: #999;">‚ö†Ô∏è M√≠nimo: ${product.minStock}</div>
                    `;

                    grid.appendChild(card);
                });

                // Actualizar filtro de productos
                updateProductFilter(inventory);
            } catch (error) {
                console.error('Error cargando inventario:', error);
            }
        }

        // Actualizar opciones del filtro de productos
        function updateProductFilter(inventory) {
            const filterProduct = document.getElementById('filterProduct');
            const currentValue = filterProduct.value;
            
            filterProduct.innerHTML = '<option value="all">Todos los productos</option>';
            
            const uniqueProducts = [...new Set(allActivities.map(a => a.product).filter(p => p))];
            uniqueProducts.sort();
            
            uniqueProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                filterProduct.appendChild(option);
            });
            
            filterProduct.value = currentValue;
        }

        // Cargar historial completo
        async function loadFullHistory() {
            try {
                const response = await fetch('/api/activities');
                allActivities = await response.json();

                document.getElementById('totalMovements').textContent = allActivities.length;

                applyFilters();
            } catch (error) {
                console.error('Error cargando historial:', error);
            }
        }

        // Aplicar filtros al historial
        function applyFilters() {
            const filterType = document.getElementById('filterType').value;
            const filterProduct = document.getElementById('filterProduct').value;
            const filterDate = document.getElementById('filterDate').value;
            const searchText = document.getElementById('searchHistory').value.toLowerCase();

            filteredActivities = allActivities.filter(activity => {
                // Filtro por tipo
                if (filterType !== 'all' && activity.type !== filterType) {
                    return false;
                }

                // Filtro por producto
                if (filterProduct !== 'all' && activity.product !== filterProduct) {
                    return false;
                }

                // Filtro por fecha
                if (filterDate !== 'all') {
                    const activityDate = new Date(activity.fullDate);
                    const now = new Date();
                    
                    if (filterDate === 'today') {
                        if (activityDate.toDateString() !== now.toDateString()) {
                            return false;
                        }
                    } else if (filterDate === 'week') {
                        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                        if (activityDate < weekAgo) {
                            return false;
                        }
                    } else if (filterDate === 'month') {
                        const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                        if (activityDate < monthAgo) {
                            return false;
                        }
                    }
                }

                // Filtro por b√∫squeda de texto
                if (searchText && !activity.text.toLowerCase().includes(searchText)) {
                    return false;
                }

                return true;
            });

            displayFilteredHistory();
        }

        // Mostrar historial filtrado
        function displayFilteredHistory() {
            const list = document.getElementById('fullHistoryList');
            document.getElementById('filteredMovements').textContent = filteredActivities.length;

            list.innerHTML = '';

            if (filteredActivities.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h3>No se encontraron movimientos</h3>
                        <p>Intenta ajustar los filtros o buscar otro t√©rmino</p>
                    </div>
                `;
                return;
            }

            filteredActivities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                let icon = 'üìù';
                let typeClass = '';
                let typeName = 'Acci√≥n';
                
                if (activity.type === 'add') {
                    icon = '‚ûï';
                    typeClass = 'type-add';
                    typeName = 'Agregar';
                } else if (activity.type === 'sell') {
                    icon = 'üí∞';
                    typeClass = 'type-sell';
                    typeName = 'Venta';
                } else if (activity.type === 'update') {
                    icon = 'üîÑ';
                    typeClass = 'type-update';
                    typeName = 'Actualizaci√≥n';
                }
                
                item.innerHTML = `
                    <div class="history-icon ${typeClass}">${icon}</div>
                    <div class="history-content">
                        <div class="history-type-badge ${typeClass}">${typeName}</div>
                        <div class="history-text">${activity.text}</div>
                        <div class="history-meta">
                            <span class="history-time">üïê ${activity.time}</span>
                            ${activity.date ? `<span class="history-date">üìÖ ${activity.date}</span>` : ''}
                            ${activity.product ? `<span class="history-product">üè∑Ô∏è ${activity.product}</span>` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterProduct').value = 'all';
            document.getElementById('filterDate').value = 'all';
            document.getElementById('searchHistory').value = '';
            applyFilters();
        }

        // Dashboard de inicio
        async function loadHomeDashboard() {
            await loadHomeActivities();
            await loadInteractiveInventory();
        }

        async function loadHomeActivities() {
            try {
                const response = await fetch('/api/activities');
                const activities = await response.json();

                const list = document.getElementById('homeActivitiesList');
                list.innerHTML = '';

                if (activities.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>No hay movimientos a√∫n</h3>
                            <p>Los movimientos que hagas por voz aparecer√°n aqu√≠</p>
                        </div>
                    `;
                    return;
                }

                activities.slice(0, 15).forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'home-activity-item';
                    
                    let icon = 'üìù';
                    let typeClass = '';
                    if (activity.type === 'add') {
                        icon = '‚ûï';
                        typeClass = 'type-add';
                    } else if (activity.type === 'sell') {
                        icon = 'üí∞';
                        typeClass = 'type-sell';
                    } else if (activity.type === 'update') {
                        icon = 'üîÑ';
                        typeClass = 'type-update';
                    }
                    
                    item.innerHTML = `
                        <div class="activity-icon ${typeClass}">${icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">${activity.text}</div>
                            <div class="activity-time">üïê ${activity.time}</div>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error cargando actividades de inicio:', error);
            }
        }

        async function loadInteractiveInventory() {
            try {
                const response = await fetch('/api/interactive-products');
                const inventory = await response.json();
                
                const grid = document.getElementById('interactiveInventoryGrid');
                grid.innerHTML = '';
                
                if (inventory.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üé§</div>
                            <h3>No hay productos activos a√∫n</h3>
                            <p>Usa comandos de voz para interactuar con productos:</p>
                            <div class="example-commands">
                                <span class="command-example">"Gwen, agrega 10 galletas"</span>
                                <span class="command-example">"Gwen, vend√≠ 5 leches"</span>
                                <span class="command-example">"Gwen, actualiza arroz a 20"</span>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                inventory.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card interactive';
                    if (product.stock <= product.minStock) {
                        card.classList.add('low-stock');
                    }
                    
                    card.innerHTML = `
                        <div class="interactive-badge">üéØ ACTIVO</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-category">
                            üìÅ ${product.category}
                        </div>
                        <div class="product-stock-info">
                            <div class="stock-main">üì¶ Stock: <strong>${product.stock}</strong> unidades</div>
                            <div class="stock-min">‚ö†Ô∏è M√≠nimo: ${product.minStock}</div>
                        </div>
                        ${product.stock <= product.minStock ? '<div class="low-stock-warning">‚ö†Ô∏è Stock Bajo</div>' : ''}
                    `;
                    
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Error cargando inventario interactivo:', error);
            }
        }

        async function loadAlerts() {
            try {
                const response = await fetch('/api/alerts');
                const alerts = await response.json();

                const lowStockGrid = document.getElementById('lowStockAlerts');
                lowStockGrid.innerHTML = '';

                if (alerts.lowStock.length === 0) {
                    lowStockGrid.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">‚úÖ Todo el stock est√° en niveles adecuados</p>';
                } else {
                    alerts.lowStock.forEach(product => {
                        const card = document.createElement('div');
                        card.className = 'alert-card low-stock-alert';
                        card.innerHTML = `
                            <div class="alert-header">
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <span class="product-name">${product.name}</span>
                            </div>
                            <div class="alert-details">
                                <div>Stock actual: <strong>${product.stock} unidades</strong></div>
                                <div>M√≠nimo requerido: ${product.minStock} unidades</div>
                                <div class="alert-urgency">${product.urgency}</div>
                            </div>
                        `;
                        lowStockGrid.appendChild(card);
                    });
                }

                const expiryGrid = document.getElementById('expiryAlerts');
                expiryGrid.innerHTML = '';

                if (alerts.expiring.length === 0) {
                    expiryGrid.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">‚úÖ No hay productos pr√≥ximos a vencer</p>';
                } else {
                    alerts.expiring.forEach(product => {
                        const card = document.createElement('div');
                        card.className = 'alert-card expiry-alert';
                        card.innerHTML = `
                            <div class="alert-header">
                                <span class="alert-icon">üìÖ</span>
                                <span class="product-name">${product.name}</span>
                            </div>
                            <div class="alert-details">
                                <div>Vence en: <strong>${product.daysUntilExpiry} d√≠as</strong></div>
                                <div>Fecha de vencimiento: ${product.expiryDate}</div>
                                <div class="alert-urgency">${product.urgency}</div>
                            </div>
                        `;
                        expiryGrid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error cargando alertas:', error);
            }
        }

        async function loadFullActivities() {
            try {
                const response = await fetch('/api/activities');
                const activities = await response.json();

                const list = document.getElementById('fullActivitiesList');
                list.innerHTML = '';

                if (activities.length === 0) {
                    list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No hay actividades registradas</p>';
                    return;
                }

                activities.forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    item.innerHTML = `
                        <div class="activity-time">üïê ${activity.time}</div>
                        <div>${activity.text}</div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error cargando actividades completas:', error);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ P√°gina cargada - Gwen lista');
            loadHomeDashboard();
        });
    </script>
</body>
</html>