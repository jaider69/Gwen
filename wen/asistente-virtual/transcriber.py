from groq import Groq
import os
from dotenv import load_dotenv
import speech_recognition as sr
import threading
import time

class Transcriber:
    def __init__(self, groq_client=None):
        load_dotenv()
        
        if groq_client:
            self.client = groq_client
        else:
            api_key = os.getenv('GROQ_API_KEY')
            if not api_key:
                print("‚ùå ERROR: GROQ_API_KEY no encontrada en .env")
                raise ValueError("GROQ_API_KEY no configurada")
            print(f"‚úÖ Groq API Key cargada: {api_key[:20]}...")
            self.client = Groq(api_key=api_key)
        
        # UNA SOLA instancia de reconocedor y micr√≥fono
        self.recognizer = sr.Recognizer()
        self.microphone = sr.Microphone()
        self.is_running = False
        self.listen_thread = None
        
        # Configuraci√≥n MEJORADA del reconocedor
        self.recognizer.pause_threshold = 1.5  # M√°s tiempo entre frases
        self.recognizer.energy_threshold = 1500  # M√°s sensible
        self.recognizer.dynamic_energy_threshold = True
        self.recognizer.dynamic_energy_adjustment_damping = 0.15
        self.recognizer.dynamic_energy_ratio = 1.5
        self.recognizer.operation_timeout = 15  # Timeout m√°s largo
        
        # Calibrar UNA VEZ
        print("üîß Calibrando micr√≥fono...")
        try:
            with self.microphone as source:
                print("   Ajustando ruido ambiente (2 segundos)...")
                self.recognizer.adjust_for_ambient_noise(source, duration=2)
                print(f"   ‚úÖ Energy threshold: {self.recognizer.energy_threshold}")
        except Exception as e:
            print(f"‚ö†Ô∏è Advertencia al calibrar: {e}")
    
    def transcribe(self, audio):
        """Transcribir archivo de audio usando Groq Whisper"""
        try:
            audio.save("audio.mp3")
            with open("audio.mp3", "rb") as audio_file:
                transcription = self.client.audio.transcriptions.create(
                    file=audio_file,
                    model="whisper-large-v3",
                    language="es",
                    response_format="text"
                )
            print(f"‚úÖ Transcripci√≥n exitosa: {transcription}")
            return transcription
        except Exception as e:
            print(f"‚ùå Error en transcripci√≥n: {e}")
            return ""
    
    def start_wake_word_system(self, on_command_callback):
        """
        Sistema completo: escucha 'Gwen', graba comando, procesa
        """
        if self.is_running:
            print("‚ö†Ô∏è El sistema ya est√° corriendo")
            return
        
        self.is_running = True
        
        def listen_loop():
            print("\n" + "="*60)
            print("üéØ SISTEMA DE VOZ INICIADO")
            print("üëÇ ESCUCHANDO ACTIVAMENTE...")
            print("   Di 'Gwen' claramente para activar")
            print("="*60 + "\n")
            
            consecutive_errors = 0
            max_errors = 10
            
            while self.is_running:
                try:
                    print("üé§ [Esperando audio...]", end=" ", flush=True)
                    
                    # PASO 1: Escuchar por "Gwen" - TIEMPO M√ÅS LARGO
                    with self.microphone as source:
                        try:
                            audio = self.recognizer.listen(
                                source, 
                                timeout=5,  # 5 segundos de timeout
                                phrase_time_limit=6   # 6 segundos para frase
                            )
                            print("‚úì Audio capturado")
                        except sr.WaitTimeoutError:
                            print("‚è±Ô∏è Timeout (silencio)")
                            continue
                    
                    # Reconocer si dijo "Gwen"
                    try:
                        print("üîç Reconociendo...", end=" ", flush=True)
                        text = self.recognizer.recognize_google(audio, language='es-ES').lower()
                        print(f"üìù Texto: '{text}'")
                        
                        # Buscar "Gwen" o variantes - AMPLIADO para mejor detecci√≥n
                        wake_words = [
                            'gwen', 'guen', 'wen', 'guin', 'g√ºen', 'gwyn', 'when',
                            'gwen', 'gen', 'jen', 'guen', 'gwen', 'glenn', 'glen',
                            'guen', 'bueno', 'gu√©n', 'hu√©n', 'wen', 'wend', 'gwend',
                            'quenel', 'quenl', 'queen', 'quen', 'guen', 'gween'
                        ]
                        
                        detected = False
                        detected_word = None
                        
                        # Buscar coincidencias exactas primero
                        for wake in wake_words:
                            if wake in text:
                                detected = True
                                detected_word = wake
                                break
                        
                        # Si no encuentra exacto, buscar palabras que empiecen similar
                        if not detected:
                            words = text.split()
                            for word in words:
                                # Buscar palabras que empiecen con 'g', 'w', 'b' y tengan 'en' o 'uen'
                                if (word.startswith(('g', 'w', 'b', 'q', 'h')) and 
                                    ('en' in word or 'uen' in word or 'wen' in word or 'gen' in word)):
                                    detected = True
                                    detected_word = word
                                    break
                        
                        if detected:
                            print("\n" + "üéØ"*20)
                            print("üéØ ¬°¬°¬°GWEN DETECTADO!!!")
                            print("üéØ"*20 + "\n")
                            
                            consecutive_errors = 0  # Resetear errores
                            
                            # NUEVO: Verificar si el comando est√° en la misma frase
                            # Remover "gwen" y sus variantes del texto
                            command_in_same_phrase = text
                            for wake in wake_words:
                                command_in_same_phrase = command_in_same_phrase.replace(wake, '').strip()
                            
                            # Si hay texto despu√©s de "Gwen", usarlo como comando
                            if command_in_same_phrase and len(command_in_same_phrase) > 3:
                                print(f"‚úÖ COMANDO DETECTADO EN LA MISMA FRASE: '{command_in_same_phrase}'")
                                print(f"‚öôÔ∏è Procesando comando...")
                                on_command_callback(command_in_same_phrase)
                            else:
                                # PASO 2: Grabar el comando por separado - TIEMPO M√ÅS LARGO
                                print("üé§ GRABANDO TU COMANDO (habla ahora - tienes 15 segundos)...")
                                time.sleep(0.5)  # Peque√±a pausa
                                
                                try:
                                    with self.microphone as source:
                                        # Grabar el comando (15 segundos max) - M√ÅS TIEMPO
                                        print("   üëÇ Escuchando comando...")
                                        command_audio = self.recognizer.listen(
                                            source, 
                                            timeout=3,  # 3 segundos para empezar
                                            phrase_time_limit=15  # 15 segundos m√°ximo
                                        )
                                        print("   ‚úÖ Comando capturado")
                                    
                                    # PASO 3: Transcribir el comando
                                    print("üìù Transcribiendo tu comando...")
                                    command_text = self.recognizer.recognize_google(
                                        command_audio, 
                                        language='es-ES'
                                    )
                                    print(f"‚úÖ COMANDO: '{command_text}'")
                                    
                                    # PASO 4: Ejecutar callback con el comando
                                    if command_text and command_text.strip():
                                        print(f"‚öôÔ∏è Procesando comando...")
                                        on_command_callback(command_text)
                                    else:
                                        print("‚ö†Ô∏è Comando vac√≠o, ignorando")
                                    
                                except sr.WaitTimeoutError:
                                    print("‚è±Ô∏è No detect√© comando despu√©s de 'Gwen'")
                                    print("   üí° Tip: Di todo junto: 'Gwen agrega 10 galletas'")
                                    # Dar feedback de error
                                    on_command_callback("comando_no_detectado")
                                except sr.UnknownValueError:
                                    print("‚ùå No entend√≠ el comando")
                                    print("   üí° Tip: Habla m√°s claro y despacio")
                                    on_command_callback("comando_no_entendido")
                                except sr.RequestError as e:
                                    print(f"‚ùå Error en API de Google: {e}")
                                    consecutive_errors += 1
                                    on_command_callback("error_servicio_voz")
                            
                            # Pausa antes de volver a escuchar "Gwen"
                            print("\n‚è≥ Esperando 3 segundos...")
                            time.sleep(3)
                            print("üëÇ Volviendo a escuchar 'Gwen'...\n")
                        else:
                            # No era "Gwen", continuar escuchando silenciosamente
                            pass
                        
                        consecutive_errors = 0  # Resetear si todo va bien
                    
                    except sr.UnknownValueError:
                        # No se entendi√≥, continuar escuchando
                        print("‚ùì No entend√≠ (normal)")
                        consecutive_errors = 0  # No es un error real
                        continue
                    except sr.RequestError as e:
                        print(f"‚ùå Error en API de Google: {e}")
                        consecutive_errors += 1
                        time.sleep(2)
                
                except Exception as e:
                    print(f"\n‚ùå Error en loop: {e}")
                    import traceback
                    traceback.print_exc()
                    consecutive_errors += 1
                    time.sleep(1)
                
                # Si hay muchos errores consecutivos, avisar
                if consecutive_errors >= max_errors:
                    print("\n" + "‚ùå"*30)
                    print(f"‚ùå Demasiados errores ({consecutive_errors}). Deteniendo sistema.")
                    print("‚ùå Posibles causas:")
                    print("   - Problemas de conexi√≥n a internet")
                    print("   - Micr√≥fono no funciona correctamente")
                    print("   - API de Google con l√≠mite de uso")
                    print("‚ùå"*30)
                    self.is_running = False
                    break
            
            print("\nüîá Sistema de voz detenido\n")
        
        # Iniciar el thread
        self.listen_thread = threading.Thread(target=listen_loop, daemon=True)
        self.listen_thread.start()
        print("‚úÖ Thread de escucha iniciado")
    
    def stop_all(self):
        """Detener TODO el sistema de voz"""
        print("\nüõë Deteniendo sistema de voz...")
        self.is_running = False
        
        if self.listen_thread and self.listen_thread.is_alive():
            print("   Esperando que el thread termine...")
            self.listen_thread.join(timeout=3)
        
        print("‚úÖ Sistema de voz detenido completamente\n")